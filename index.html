<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STåˆ†é¡ãƒã‚¹ã‚¿ãƒ¼ï¼ˆç·¨é›†æ©Ÿèƒ½ä»˜ãï¼‰</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --selected: #f1c40f;
            --correct: #27ae60;
            --wrong: #e74c3c;
            --bg: #ecf0f1;
            --text: #333;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: var(--text);
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            padding: 10px 15px;
            background: var(--primary);
            color: white;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .edit-toggle-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .status-bar {
            background: #eee;
            padding: 5px 15px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            border-bottom: 1px solid #ddd;
        }

        /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        .game-area {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        @media (min-width: 600px) {
            .game-area { flex-direction: row; }
        }

        /* å·¦å´ï¼šã‚«ãƒ†ã‚´ãƒªï¼ˆå¤§æ ï¼‰ã‚¨ãƒªã‚¢ */
        .category-area {
            flex: 1;
            background: #f8f9fa;
            padding: 10px;
            overflow-y: auto;
            border-bottom: 2px solid #ddd;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            align-content: start;
        }

        @media (min-width: 600px) {
            .category-area {
                flex: 0 0 35%;
                border-bottom: none;
                border-right: 2px solid #ddd;
                grid-template-columns: 1fr;
            }
        }

        .category-btn {
            background: white;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            padding: 15px;
            font-weight: bold;
            font-size: 0.95rem;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        .category-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .category-btn.flash-correct {
            background-color: var(--correct) !important;
            border-color: var(--correct) !important;
            color: white;
        }

        /* å³å´ï¼šè¦ç´ ã‚¨ãƒªã‚¢ */
        .items-area {
            flex: 1.5;
            padding: 20px;
            background: white;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .items-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        .item-card {
            background: white;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: 0.2s;
            animation: popIn 0.3s ease;
        }

        .item-card:hover { transform: translateY(-2px); }
        .item-card.correct-anim { transform: scale(0); opacity: 0; transition: 0.3s; }
        .item-card.wrong-anim { background: var(--wrong); color: white; border-color: var(--wrong); animation: shake 0.4s ease; }

        /* çµæœç”»é¢ */
        #result-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }

        /* === ç·¨é›†ç”»é¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ === */
        #edit-screen {
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            flex-direction: column;
            padding: 20px;
            background: white;
            height: 100%;
            overflow-y: auto;
        }

        .edit-section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background: #fdfdfd;
        }

        .edit-label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .input-text {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .input-area {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-danger {
            background: var(--wrong);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .existing-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        .existing-item {
            background: #eee;
            margin-bottom: 5px;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-io-area {
            background: #333;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25%, 75% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .instruction {
            margin-bottom: 10px;
            color: #666;
            font-size: 0.9rem;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-title">STåˆ†é¡ãƒã‚¹ã‚¿ãƒ¼</div>
        <button class="edit-toggle-btn" onclick="toggleEditMode()">ä½œå•ãƒ»ç·¨é›†</button>
    </header>

    <div id="play-container" style="display: flex; flex-direction: column; height: 100%;">
        <div class="status-bar">
            <span id="mode-display">å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰</span>
            <span id="progress-display">æ®‹ã‚Š: 0</span>
        </div>

        <div id="game-screen" class="game-area">
            <div class="category-area" id="category-container"></div>
            <div class="items-area">
                <p class="instruction" id="instruction-text">å·¦(ä¸Š)ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <div class="items-grid" id="items-container"></div>
            </div>
        </div>

        <div id="result-screen">
            <h1 id="result-title">å®Œäº†ï¼</h1>
            <p id="result-msg">åˆ†é¡å®Œäº†</p>
            <button class="btn-primary" style="background:var(--wrong); margin-bottom:10px;" id="retry-btn" onclick="startReview()">å¾©ç¿’ã™ã‚‹</button>
            <button class="btn-primary" onclick="restartGame()">æœ€åˆã‹ã‚‰</button>
        </div>
    </div>

    <div id="edit-screen">
        <h2>å•é¡Œã®ä½œæˆãƒ»ç·¨é›†</h2>
        <p style="font-size:0.9rem; color:#666;">ã“ã“ã§å…¥åŠ›ã—ãŸå•é¡Œã¯è‡ªå‹•ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>

        <div class="edit-section">
            <label class="edit-label">æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ </label>
            <input type="text" id="new-cat-name" class="input-text" placeholder="ã‚«ãƒ†ã‚´ãƒªåï¼ˆä¾‹ï¼šå‰é ­è‘‰ï¼‰">
            <label class="edit-label">å«ã¾ã‚Œã‚‹è¦ç´ ï¼ˆæ”¹è¡Œã§åŒºåˆ‡ã£ã¦å…¥åŠ›ï¼‰</label>
            <textarea id="new-cat-items" class="input-area" placeholder="ãƒ–ãƒ­ãƒ¼ã‚«é‡&#13;&#10;ä¸€æ¬¡é‹å‹•é‡&#13;&#10;æ„æ¬²ä½ä¸‹"></textarea>
            <button class="btn-primary" onclick="addCategory()">è¿½åŠ ã™ã‚‹</button>
        </div>

        <div class="edit-section">
            <label class="edit-label">ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</label>
            <ul class="existing-list" id="edit-list">
                </ul>
        </div>

        <div class="data-io-area">
            <label class="edit-label" style="color:#fff;">ã€ãƒ‡ãƒ¼ã‚¿é…å¸ƒãƒ»å…±æœ‰ã€‘</label>
            <p style="font-size:0.8rem;">å…ˆç”ŸãŒä½œã£ãŸå•é¡Œã‚’ç”Ÿå¾’ã«é…ã‚‹å ´åˆãªã©ã«ä½¿ç”¨ã—ã¾ã™ã€‚</p>
            <div class="btn-group">
                <button class="btn-primary" style="background:#555; border:1px solid #aaa;" onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆæ›¸ãå‡ºã—ï¼‰</button>
                <button class="btn-primary" style="background:#555; border:1px solid #aaa;" onclick="importData()">ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆèª­ã¿è¾¼ã¿ï¼‰</button>
            </div>
        </div>

        <button class="btn-primary" style="width:100%; margin-top:20px;" onclick="toggleEditMode()">å­¦ç¿’ç”»é¢ã«æˆ»ã‚‹</button>
    </div>
</div>

<script>
    // --- åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰ ---
    const defaultData = {
        "å¤±èªç—‡ã®åˆ†é¡": ["ãƒ–ãƒ­ãƒ¼ã‚«å¤±èª", "ã‚¦ã‚§ãƒ«ãƒ‹ãƒƒã‚±å¤±èª", "ä¼å°å¤±èª", "å…¨å¤±èª"],
        "æ§‹éŸ³éšœå®³": ["ç—™æ€§æ§‹éŸ³éšœå®³", "å¼›ç·©æ€§æ§‹éŸ³éšœå®³", "å¤±èª¿æ€§æ§‹éŸ³éšœå®³", "é‹å‹•ä½ä¸‹æ€§"],
        "è„³ç¥çµŒ": ["è¦–ç¥çµŒ", "å‹•çœ¼ç¥çµŒ", "æ»‘è»Šç¥çµŒ", "ä¸‰å‰ç¥çµŒ", "å¤–è»¢ç¥çµŒ"]
    };

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let problemData = {};
    let allItems = [];
    let currentQueue = [];
    let wrongQueue = [];
    let activeCategory = null;
    let isReviewMode = false;
    const CHUNK_SIZE = 6;

    // --- UIè¦ç´  ---
    const ui = {
        playContainer: document.getElementById('play-container'),
        editScreen: document.getElementById('edit-screen'),
        game: document.getElementById('game-screen'),
        result: document.getElementById('result-screen'),
        cats: document.getElementById('category-container'),
        items: document.getElementById('items-container'),
        progress: document.getElementById('progress-display'),
        mode: document.getElementById('mode-display'),
        resTitle: document.getElementById('result-title'),
        resMsg: document.getElementById('result-msg'),
        retryBtn: document.getElementById('retry-btn'),
        instruction: document.getElementById('instruction-text')
    };

    // === ã‚·ã‚¹ãƒ†ãƒ èµ·å‹• ===
    window.onload = function() {
        loadProblemData();
        initGame();
        renderEditList();
    };

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆLocalStorageå„ªå…ˆï¼‰
    function loadProblemData() {
        const saved = localStorage.getItem('st_master_data');
        if (saved) {
            try {
                problemData = JSON.parse(saved);
            } catch(e) {
                problemData = JSON.parse(JSON.stringify(defaultData));
            }
        } else {
            problemData = JSON.parse(JSON.stringify(defaultData));
        }
    }

    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    function saveData() {
        localStorage.setItem('st_master_data', JSON.stringify(problemData));
    }

    // === å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ ===
    function initGame() {
        // ãƒ•ãƒ©ãƒƒãƒˆåŒ–
        allItems = [];
        for (const [cat, list] of Object.entries(problemData)) {
            list.forEach(itemText => {
                allItems.push({ name: itemText, category: cat });
            });
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ç”Ÿæˆ
        ui.cats.innerHTML = "";
        Object.keys(problemData).forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'category-btn';
            btn.innerText = cat;
            btn.onclick = () => selectCategory(cat, btn);
            ui.cats.appendChild(btn);
        });

        restartGame();
    }

    function restartGame() {
        isReviewMode = false;
        ui.mode.innerText = "å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰";
        ui.mode.style.color = "#333";
        currentQueue = shuffle([...allItems]);
        wrongQueue = [];
        ui.result.style.display = 'none';
        ui.game.style.display = 'flex';
        activeCategory = null;
        updateInstruction();
        
        // ã‚«ãƒ†ã‚´ãƒªé¸æŠçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));

        nextRound();
    }

    function nextRound() {
        // ç”»é¢ã«ã¾ã æ®‹ã£ã¦ã„ã‚‹ãªã‚‰è£œå……ã—ãªã„
        if (ui.items.children.length > 0) return;

        if (currentQueue.length === 0) {
            finishGame();
            return;
        }

        const nextBatch = currentQueue.splice(0, CHUNK_SIZE);
        renderItems(nextBatch);
        updateStatus();
    }

    function renderItems(list) {
        ui.items.innerHTML = "";
        list.forEach(itemObj => {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerText = itemObj.name;
            card.onclick = (e) => handleItemClick(itemObj, e.target);
            ui.items.appendChild(card);
        });
    }

    function selectCategory(catName, btnElement) {
        const prev = document.querySelector('.category-btn.active');
        if (prev) prev.classList.remove('active');
        activeCategory = catName;
        btnElement.classList.add('active');
        updateInstruction();
    }

    function updateInstruction() {
        if (!activeCategory) {
            ui.instruction.innerText = "ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„";
            ui.instruction.style.color = "#666";
        } else {
            ui.instruction.innerText = `ã€Œ${activeCategory}ã€ã®è¦ç´ ã‚’é¸ã‚“ã§ãã ã•ã„`;
            ui.instruction.style.color = "var(--primary)";
            ui.instruction.style.fontWeight = "bold";
        }
    }

    function handleItemClick(itemObj, cardElem) {
        if (!activeCategory) {
            alert("å…ˆã«ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ï¼");
            return;
        }

        if (itemObj.category === activeCategory) {
            // æ­£è§£
            cardElem.classList.add('correct-anim');
            const activeBtn = document.querySelector('.category-btn.active');
            activeBtn.classList.add('flash-correct');
            setTimeout(() => activeBtn.classList.remove('flash-correct'), 300);

            setTimeout(() => {
                cardElem.remove();
                if (ui.items.children.length === 0) nextRound();
                updateStatus();
            }, 300);
        } else {
            // ä¸æ­£è§£
            cardElem.classList.add('wrong-anim');
            // å¾©ç¿’ãƒªã‚¹ãƒˆã¸ï¼ˆé‡è¤‡ãªã—ï¼‰
            const alreadyInWrong = wrongQueue.some(w => w.name === itemObj.name && w.category === itemObj.category);
            if (!alreadyInWrong) {
                wrongQueue.push(itemObj);
            }
            setTimeout(() => cardElem.classList.remove('wrong-anim'), 400);
        }
    }

    function updateStatus() {
        const total = currentQueue.length + ui.items.children.length;
        ui.progress.innerText = `æ®‹ã‚Š: ${total}`;
    }

    function finishGame() {
        ui.game.style.display = 'none';
        ui.result.style.display = 'flex';

        if (wrongQueue.length === 0) {
            ui.resTitle.innerText = "å®Œå…¨ç¿’å¾—ï¼ğŸ‰";
            ui.resTitle.style.color = "var(--correct)";
            ui.resMsg.innerText = "ã™ã¹ã¦ã®åˆ†é¡ãŒå®Œäº†ã—ã¾ã—ãŸ";
            ui.retryBtn.style.display = 'none';
        } else {
            ui.resTitle.innerText = "å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã¸";
            ui.resTitle.style.color = "var(--wrong)";
            ui.resMsg.innerText = `${wrongQueue.length} å€‹ã®é–“é•ã„ãŒã‚ã‚Šã¾ã—ãŸã€‚\nå…¨å•æ­£è§£ã™ã‚‹ã¾ã§çµ‚ã‚ã‚Šã¾ã›ã‚“ï¼`;
            ui.retryBtn.style.display = 'block';
        }
    }

    function startReview() {
        isReviewMode = true;
        ui.mode.innerText = "ğŸ”¥ å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰";
        ui.mode.style.color = "var(--wrong)";
        
        currentQueue = shuffle([...wrongQueue]);
        wrongQueue = []; // ä»Šå›é–“é•ãˆãŸã‚‰ã¾ãŸå…¥ã‚‹
        
        ui.result.style.display = 'none';
        ui.game.style.display = 'flex';
        nextRound();
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // === ç·¨é›†ãƒ»ç®¡ç†æ©Ÿèƒ½ ===
    function toggleEditMode() {
        if (ui.editScreen.style.display === 'flex') {
            ui.editScreen.style.display = 'none';
            ui.playContainer.style.display = 'flex';
            // ç·¨é›†å†…å®¹ã‚’åæ˜ ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
            initGame();
        } else {
            ui.playContainer.style.display = 'none';
            ui.editScreen.style.display = 'flex';
            renderEditList();
        }
    }

    function addCategory() {
        const name = document.getElementById('new-cat-name').value.trim();
        const itemsText = document.getElementById('new-cat-items').value.trim();
        
        if (!name || !itemsText) {
            alert("ã‚«ãƒ†ã‚´ãƒªåã¨è¦ç´ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        // æ”¹è¡Œã§åˆ†å‰²ã—ã¦ãƒªã‚¹ãƒˆåŒ–
        const items = itemsText.split(/\n/).map(s => s.trim()).filter(s => s !== "");
        
        if (items.length === 0) {
            alert("è¦ç´ ãŒã‚ã‚Šã¾ã›ã‚“");
            return;
        }

        problemData[name] = items;
        saveData();
        renderEditList();

        // å…¥åŠ›ã‚¯ãƒªã‚¢
        document.getElementById('new-cat-name').value = "";
        document.getElementById('new-cat-items').value = "";
    }

    function deleteCategory(catName) {
        if (confirm(`ã‚«ãƒ†ã‚´ãƒªã€Œ${catName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            delete problemData[catName];
            saveData();
            renderEditList();
        }
    }

    function renderEditList() {
        const listElem = document.getElementById('edit-list');
        listElem.innerHTML = "";
        
        Object.keys(problemData).forEach(cat => {
            const li = document.createElement('li');
            li.className = 'existing-item';
            li.innerHTML = `
                <span><b>${cat}</b> (${problemData[cat].length}å€‹)</span>
                <button class="btn-danger" onclick="deleteCategory('${cat}')">å‰Šé™¤</button>
            `;
            listElem.appendChild(li);
        });
    }

    // === ãƒ‡ãƒ¼ã‚¿å…±æœ‰æ©Ÿèƒ½ ===
    function exportData() {
        const json = JSON.stringify(problemData);
        navigator.clipboard.writeText(json).then(() => {
            alert("ç¾åœ¨ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nå­¦ç”Ÿã«LINEã‚„ãƒ¡ãƒ¼ãƒ«ã§é€ã£ã¦ãã ã•ã„ã€‚");
        }).catch(() => {
            prompt("ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦é…å¸ƒã—ã¦ãã ã•ã„", json);
        });
    }

    function importData() {
        const json = prompt("å…ˆç”Ÿã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„");
        if (json) {
            try {
                const data = JSON.parse(json);
                if (typeof data === 'object') {
                    problemData = data;
                    saveData();
                    alert("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
                    renderEditList();
                } else {
                    alert("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
                }
            } catch(e) {
                alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }
    }

</script>

</body>
</html>