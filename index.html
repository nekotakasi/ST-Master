<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†é¡ãƒã‚¹ã‚¿ãƒ¼ï¼ˆè‹¦æ‰‹åˆ†ææ©Ÿèƒ½ä»˜ï¼‰</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --correct: #27ae60;
            --wrong: #e74c3c;
            --edit: #f39c12;
            --bg: #f5f6fa;
            --text: #2c3e50;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg);
            margin: 0;
            color: var(--text);
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: var(--primary);
            color: white;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
        }

        /* ç”»é¢å…±é€šè¨­å®š */
        .screen {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
        }

        .screen.active {
            display: flex;
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆ */
        .menu-list {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }

        .menu-btn {
            background: white;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            padding: 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .menu-btn:hover {
            background: var(--secondary);
            color: white;
            transform: translateY(-2px);
        }
        
        .menu-btn.recent::after {
            content: "â—";
            color: var(--correct);
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8rem;
        }

        .clear-date {
            font-size: 0.8rem;
            color: var(--correct);
            margin-top: 5px;
            font-weight: normal;
            background: #e8f8f5;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .menu-btn:hover .clear-date {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .section-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--secondary);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        .game-layout {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        @media (min-width: 600px) {
            .game-layout { flex-direction: row; }
        }

        .category-area {
            flex: 0 0 auto;
            max-height: 40%;
            background: #ecf0f1;
            padding: 10px;
            border-bottom: 2px solid #bdc3c7;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        @media (min-width: 600px) {
            .category-area {
                flex: 0 0 35%;
                max-height: none;
                border-bottom: none;
                border-right: 2px solid #bdc3c7;
                grid-template-columns: 1fr;
                align-content: start;
            }
        }

        .cat-btn {
            background: white;
            border: 2px solid #95a5a6;
            border-radius: 8px;
            padding: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .cat-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
        }

        .cat-btn.flash {
            background: var(--correct) !important;
            border-color: var(--correct) !important;
            color: white !important;
        }

        .items-area {
            flex: 1;
            padding: 20px;
            background: white;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .item-card {
            background: white;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: 0.2s;
            animation: popIn 0.3s ease;
        }

        .item-card:hover { transform: translateY(-2px); }
        .item-card.correct { transform: scale(0); opacity: 0; }
        .item-card.wrong { background: var(--wrong); color: white; border-color: var(--wrong); animation: shake 0.4s; }

        .progress-bar {
            background: #eee;
            height: 6px;
            width: 100%;
            margin-bottom: 10px;
        }
        .progress-fill {
            background: var(--correct);
            height: 100%;
            width: 0%;
            transition: 0.3s;
        }

        /* çµæœç”»é¢ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        .ranking-area {
            margin: 20px 0;
            padding: 15px;
            background: #fdf2f2;
            border-radius: 10px;
            border: 1px solid #f5c6cb;
            width: 90%;
            max-width: 400px;
        }
        .ranking-title {
            color: var(--wrong);
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        .ranking-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }
        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #f5c6cb;
        }
        .ranking-rank {
            font-weight: bold;
            margin-right: 10px;
            color: var(--secondary);
        }

        /* ç·¨é›†ç”»é¢ */
        .form-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .form-label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: var(--primary);
        }
        .input-box, .select-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        
        .btn-danger {
            background: var(--wrong);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-edit {
            background: var(--edit);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .btn-delete-section {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            flex: 1; 
        }

        .backup-area {
            background: #34495e;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .backup-text {
            font-size: 0.85rem;
            color: #bdc3c7;
            margin-bottom: 10px;
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: 1; opacity: 1; } }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%,75%{transform:translateX(-5px)} 50%{transform:translateX(5px)} }

    </style>
</head>
<body>

<div class="container">
    <header>
        <button class="header-btn" id="back-btn" onclick="goBack()" style="visibility:hidden;">â† æˆ»ã‚‹</button>
        <div class="header-title" id="header-title">åˆ†é¡ãƒã‚¹ã‚¿ãƒ¼</div>
        <button class="header-btn" onclick="toggleEdit()">ä½œå•</button>
    </header>

    <div id="screen-subjects" class="screen active">
        <h2 class="section-title">ç§‘ç›®ã‚’é¸æŠ</h2>
        <div class="menu-list" id="subject-list"></div>
    </div>

    <div id="screen-titles" class="screen">
        <h2 class="section-title" id="selected-subject-name"></h2>
        <div class="menu-list" id="title-list"></div>
    </div>

    <div id="screen-game" class="screen" style="padding:0; overflow:hidden;">
        <div style="padding: 10px; background: #fff; border-bottom:1px solid #eee;">
            <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
            <div style="text-align:center; font-size:0.9rem;" id="game-status">æ®‹ã‚Š: 0</div>
            <div style="text-align:center; font-size:0.9rem; color:#888;" id="instruction-text">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</div>
        </div>
        
        <div class="game-layout">
            <div class="category-area" id="game-cats"></div>
            <div class="items-area">
                <div id="game-items" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen" style="text-align:center; align-items:center; justify-content:center;">
        <h1 id="result-msg">å®Œäº†ï¼</h1>
        <p id="result-sub">å…¨åˆ†é¡ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ãŸ</p>

        <div id="worst-ranking-container" class="ranking-area" style="display:none;">
            <div class="ranking-title">âš ï¸ ã‚ˆãé–“é•ãˆã‚‹è¦ç´  TOP3</div>
            <ul id="worst-list" class="ranking-list"></ul>
        </div>

        <button class="btn-primary" id="retry-btn" onclick="startReview()" style="background:var(--wrong); margin-bottom:10px; display:none;">é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’ã™ã‚‹</button>
        <button class="btn-primary" onclick="initGame(currentSubject, currentTitle)">ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
        <button class="btn-primary" onclick="goSubjects()" style="margin-top:10px; background:var(--secondary);">ç§‘ç›®ä¸€è¦§ã«æˆ»ã‚‹</button>
    </div>

    <div id="screen-edit" class="screen">
        <h2 class="section-title">å•é¡Œã®ä½œæˆãƒ»ç·¨é›†</h2>

        <div class="form-group">
            <label class="form-label">â‘  ç§‘ç›®ã‚’é¸æŠ / æ–°è¦ä½œæˆ / å‰Šé™¤</label>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <select id="edit-subject-select" class="select-box" style="margin-bottom:0;" onchange="onEditSubjectChange()">
                    <option value="">-- ç§‘ç›®ã‚’é¸æŠ --</option>
                </select>
                <button id="btn-del-subject" class="btn-delete-section" style="display:none; max-width:80px;" onclick="deleteSelectedSubject()">å‰Šé™¤</button>
            </div>
            <input type="text" id="edit-new-subject" class="input-box" placeholder="æ–°ã—ã„ç§‘ç›®åï¼ˆä¾‹ï¼šè§£å‰–å­¦ï¼‰">
            <button class="btn-primary" onclick="addNewSubject()">ç§‘ç›®ã‚’è¿½åŠ </button>
        </div>

        <div class="form-group" id="edit-title-group" style="display:none; border-left: 5px solid var(--accent);">
            <label class="form-label">â‘¡ ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¸æŠ / æ–°è¦ä½œæˆ / å‰Šé™¤</label>
            <p style="font-size:0.8rem; color:#666;">é¸æŠä¸­ã®ç§‘ç›®ï¼š<b id="edit-current-subject"></b></p>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <select id="edit-title-select" class="select-box" style="margin-bottom:0;" onchange="onEditTitleChange()">
                    <option value="">-- ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¸æŠ --</option>
                </select>
                <button id="btn-del-title" class="btn-delete-section" style="display:none; max-width:80px;" onclick="deleteSelectedTitle()">å‰Šé™¤</button>
            </div>
            <input type="text" id="edit-new-title" class="input-box" placeholder="æ–°ã—ã„ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šè„³ã®æ©Ÿèƒ½ï¼‰">
            <button class="btn-primary" onclick="addNewTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ </button>
        </div>

        <div class="form-group" id="edit-content-group" style="display:none; border-left: 5px solid var(--correct);">
            <label class="form-label">â‘¢ åˆ†é¡å•é¡Œã‚’è¿½åŠ ãƒ»ç·¨é›†</label>
            <p style="font-size:0.8rem; color:#666;">é¸æŠä¸­ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼š<b id="edit-current-title"></b></p>
            <label class="form-label">å¤§æ ï¼ˆã‚«ãƒ†ã‚´ãƒªåï¼‰</label>
            <input type="text" id="edit-cat-name" class="input-box" placeholder="ä¾‹ï¼šæœç‰©">
            <label class="form-label">è¦ç´ ï¼ˆæ”¹è¡Œã§åŒºåˆ‡ã‚‹ï¼‰</label>
            <textarea id="edit-cat-items" class="input-box" style="height:100px;" placeholder="ä¾‹ï¼š&#13;&#10;ã‚Šã‚“ã”&#13;&#10;ã¿ã‹ã‚“"></textarea>
            <button class="btn-primary" onclick="addProblemContent()">ã“ã®å†…å®¹ã§ä¿å­˜ï¼ˆä¸Šæ›¸ãï¼‰</button>
            <hr style="margin:20px 0; border:0; border-top:1px solid #ddd;">
            <label class="form-label">ç™»éŒ²æ¸ˆã¿ã®å¤§æ ãƒªã‚¹ãƒˆ</label>
            <ul id="edit-registered-list" style="padding-left:20px; font-size:0.9rem;"></ul>
        </div>

        <div class="backup-area">
            <label class="form-label" style="color:white;">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</label>
            <p class="backup-text">
                ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«ã¯ã€Œå­¦ç¿’å±¥æ­´ã€ã‚„ã€Œé–“é•ã„åˆ†æãƒ‡ãƒ¼ã‚¿ã€ã‚‚å«ã¾ã‚Œã¾ã™ã€‚<br>
                å®šæœŸçš„ã«ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
            </p>
            <div style="display:flex; gap:10px;">
                <button class="btn-primary" style="background:#7f8c8d; border:1px solid white;" onclick="exportBackup()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼</button>
                <button class="btn-primary" style="background:#7f8c8d; border:1px solid white;" onclick="importBackup()">ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ</button>
            </div>
        </div>
    </div>

</div>

<script>
    // === ãƒ‡ãƒ¼ã‚¿æ§‹é€  ===
    const defaultData = {
        "ç·´ç¿’ç”¨": {
            "ä¾‹é¡Œï¼šç”Ÿãç‰©": {
                "æœç‰©": ["ã‚Šã‚“ã”", "ã¿ã‹ã‚“", "ãƒãƒŠãƒŠ"],
                "å‹•ç‰©": ["ã„ã¬", "ã­ã“", "ã†ã•ã"]
            }
        }
    };

    let appData = {};
    let accessLog = {}; 
    let completionLog = {}; 
    let mistakeLog = {}; // â˜…æ–°æ©Ÿèƒ½ï¼šé–“é•ã„ã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚° { "ç§‘ç›®__ã‚¿ã‚¤ãƒˆãƒ«__è¦ç´ å": å›æ•° }

    let currentSubject = null;
    let currentTitle = null;
    
    // ã‚²ãƒ¼ãƒ ç”¨å¤‰æ•°
    let activeCategory = null;
    let gameQueue = [];
    let wrongQueue = [];
    let allItemsCount = 0;
    const CHUNK_SIZE = 6;

    // === åˆæœŸåŒ– ===
    window.onload = () => {
        loadData();
        goSubjects();
    };

    function loadData() {
        const json = localStorage.getItem('st_hier_data');
        if (json) {
            try { appData = JSON.parse(json); } catch(e) { appData = defaultData; }
        } else {
            appData = JSON.parse(JSON.stringify(defaultData));
        }

        const logJson = localStorage.getItem('st_access_log');
        if (logJson) {
            try { accessLog = JSON.parse(logJson); } catch(e) { accessLog = {}; }
        }

        const compJson = localStorage.getItem('st_completion_log');
        if (compJson) {
            try { completionLog = JSON.parse(compJson); } catch(e) { completionLog = {}; }
        }

        const misJson = localStorage.getItem('st_mistake_log');
        if (misJson) {
            try { mistakeLog = JSON.parse(misJson); } catch(e) { mistakeLog = {}; }
        }
    }

    function saveData() {
        localStorage.setItem('st_hier_data', JSON.stringify(appData));
        localStorage.setItem('st_access_log', JSON.stringify(accessLog));
        localStorage.setItem('st_completion_log', JSON.stringify(completionLog));
        localStorage.setItem('st_mistake_log', JSON.stringify(mistakeLog));
    }

    function updateAccessLog(key) {
        accessLog[key] = Date.now();
        saveData();
    }

    // === ç”»é¢é·ç§» ===
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        const backBtn = document.getElementById('back-btn');
        if (id === 'screen-subjects') {
            backBtn.style.visibility = 'hidden';
            document.getElementById('header-title').innerText = "åˆ†é¡ãƒã‚¹ã‚¿ãƒ¼";
        } else {
            backBtn.style.visibility = 'visible';
        }
    }

    function goBack() {
        const active = document.querySelector('.screen.active').id;
        if (active === 'screen-titles') goSubjects();
        else if (active === 'screen-game') goTitles(currentSubject);
        else if (active === 'screen-result') goTitles(currentSubject);
        else if (active === 'screen-edit') goSubjects();
        else goSubjects();
    }

    // 1. ç§‘ç›®ä¸€è¦§
    function goSubjects() {
        currentSubject = null;
        currentTitle = null;
        const list = document.getElementById('subject-list');
        list.innerHTML = "";
        
        const sortedSubjects = Object.keys(appData).sort((a, b) => {
            const timeA = accessLog[a] || 0;
            const timeB = accessLog[b] || 0;
            return timeB - timeA;
        });

        sortedSubjects.forEach(subj => {
            const btn = document.createElement('div');
            btn.className = 'menu-btn';
            btn.innerText = subj;
            btn.onclick = () => {
                updateAccessLog(subj);
                goTitles(subj);
            };
            list.appendChild(btn);
        });
        showScreen('screen-subjects');
    }

    // 2. ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§
    function goTitles(subj) {
        currentSubject = subj;
        document.getElementById('selected-subject-name').innerText = subj;
        const list = document.getElementById('title-list');
        list.innerHTML = "";
        
        const titlesObj = appData[subj] || {};
        
        if (Object.keys(titlesObj).length === 0) {
            list.innerHTML = "<p style='text-align:center; width:100%; color:#888;'>ã¾ã å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å³ä¸Šã®ã€Œä½œå•ã€ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>";
        }

        const sortedTitles = Object.keys(titlesObj).sort((a, b) => {
            const keyA = `${subj}__${a}`;
            const keyB = `${subj}__${b}`;
            const timeA = accessLog[keyA] || 0;
            const timeB = accessLog[keyB] || 0;
            return timeB - timeA;
        });

        sortedTitles.forEach(title => {
            const btn = document.createElement('div');
            btn.className = 'menu-btn';
            
            const titleSpan = document.createElement('div');
            titleSpan.innerText = title;
            btn.appendChild(titleSpan);

            const key = `${subj}__${title}`;
            if (completionLog[key]) {
                const dateDiv = document.createElement('div');
                dateDiv.className = 'clear-date';
                dateDiv.innerText = `ğŸ† æœ€çµ‚ã‚¯ãƒªã‚¢: ${completionLog[key]}`;
                btn.appendChild(dateDiv);
            }

            btn.onclick = () => {
                updateAccessLog(key);
                initGame(subj, title);
            };
            list.appendChild(btn);
        });
        
        document.getElementById('header-title').innerText = subj;
        showScreen('screen-titles');
    }

    // 3. ã‚²ãƒ¼ãƒ é–‹å§‹
    function initGame(subj, title) {
        currentSubject = subj;
        currentTitle = title;
        document.getElementById('header-title').innerText = title;

        const problemSet = appData[subj][title];
        let items = [];
        for (const [cat, list] of Object.entries(problemSet)) {
            list.forEach(item => items.push({name: item, category: cat}));
        }

        gameQueue = shuffle(items);
        wrongQueue = [];
        allItemsCount = items.length;
        activeCategory = null;

        const catArea = document.getElementById('game-cats');
        catArea.innerHTML = "";
        Object.keys(problemSet).forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'cat-btn';
            btn.innerText = cat;
            btn.onclick = () => selectCategory(cat, btn);
            catArea.appendChild(btn);
        });

        document.getElementById('game-items').innerHTML = "";
        showScreen('screen-game');
        updateInstruction();
        nextRound();
    }

    function selectCategory(cat, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeCategory = cat;
        updateInstruction();
    }

    function updateInstruction() {
        const text = document.getElementById('instruction-text');
        if (!activeCategory) {
            text.innerText = "â‘ å¤§æ (ã‚«ãƒ†ã‚´ãƒª)ã‚’é¸æŠã—ã¦ãã ã•ã„";
            text.style.color = "#888";
        } else {
            text.innerText = `ã€Œ${activeCategory}ã€ã«åˆ†é¡ã™ã‚‹è¦ç´ ã‚’é¸ã‚“ã§ãã ã•ã„`;
            text.style.color = "var(--accent)";
        }
    }

    function nextRound() {
        const container = document.getElementById('game-items');
        if (container.children.length > 0) return;

        if (gameQueue.length === 0) {
            finishGame();
            return;
        }

        const batch = gameQueue.splice(0, CHUNK_SIZE);
        batch.forEach(item => {
            const el = document.createElement('div');
            el.className = 'item-card';
            el.innerText = item.name;
            el.onclick = (e) => checkAnswer(item, e.target);
            container.appendChild(el);
        });
        updateStatus();
    }

    function checkAnswer(item, el) {
        if (!activeCategory) {
            alert("å…ˆã«ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }

        if (item.category === activeCategory) {
            el.classList.add('correct');
            const activeBtn = document.querySelector('.cat-btn.active');
            activeBtn.classList.add('flash');
            setTimeout(() => activeBtn.classList.remove('flash'), 300);

            setTimeout(() => {
                el.remove();
                if (document.getElementById('game-items').children.length === 0) nextRound();
                updateStatus();
            }, 300);
        } else {
            el.classList.add('wrong');
            
            // é–“é•ã„ãƒªã‚¹ãƒˆã«è¿½åŠ 
            const alreadyInWrong = wrongQueue.some(w => w.name === item.name && w.category === item.category);
            if (!alreadyInWrong) {
                wrongQueue.push(item);
            }

            // â˜…é–“é•ã„ã‚«ã‚¦ãƒ³ãƒˆã‚’åŠ ç®—
            const mistakeKey = `${currentSubject}__${currentTitle}__${item.name}`;
            mistakeLog[mistakeKey] = (mistakeLog[mistakeKey] || 0) + 1;
            saveData();

            setTimeout(() => el.classList.remove('wrong'), 400);
        }
    }

    function updateStatus() {
        const remaining = gameQueue.length + document.getElementById('game-items').children.length;
        document.getElementById('game-status').innerText = `æ®‹ã‚Š: ${remaining}`;
        const total = allItemsCount;
        const current = total - remaining;
        document.getElementById('progress-bar').style.width = `${(current/total)*100}%`;
    }

    function finishGame() {
        showScreen('screen-result');
        const title = document.getElementById('result-msg');
        const sub = document.getElementById('result-sub');
        const retryBtn = document.getElementById('retry-btn');
        const rankingContainer = document.getElementById('worst-ranking-container');
        const rankingList = document.getElementById('worst-list');

        if (wrongQueue.length === 0) {
            // â˜…å®Œå…¨ç¿’å¾—ï¼æ—¥ä»˜ã‚’ä¿å­˜
            const today = new Date();
            const dateStr = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
            const key = `${currentSubject}__${currentTitle}`;
            completionLog[key] = dateStr;
            saveData();

            title.innerText = "å®Œå…¨ç¿’å¾—ï¼ğŸ‰";
            title.style.color = "var(--correct)";
            sub.innerText = "å­¦ç¿’è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚";
            retryBtn.style.display = "none";

            // â˜…ãƒ¯ãƒ¼ã‚¹ãƒˆ3ã®è¡¨ç¤ºå‡¦ç†
            const prefix = `${currentSubject}__${currentTitle}__`;
            const mistakes = [];
            
            Object.keys(mistakeLog).forEach(k => {
                if(k.startsWith(prefix)) {
                    mistakes.push({
                        name: k.replace(prefix, ''),
                        count: mistakeLog[k]
                    });
                }
            });

            // å›æ•°ãŒå¤šã„é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ãƒˆãƒƒãƒ—3ã‚’å–å¾—
            mistakes.sort((a, b) => b.count - a.count);
            const top3 = mistakes.slice(0, 3);

            if (top3.length > 0 && top3[0].count > 0) {
                rankingContainer.style.display = "block";
                rankingList.innerHTML = "";
                top3.forEach((m, index) => {
                    const li = document.createElement('li');
                    li.className = "ranking-item";
                    li.innerHTML = `
                        <span><span class="ranking-rank">${index + 1}ä½</span> ${m.name}</span>
                        <span>${m.count}å›</span>
                    `;
                    rankingList.appendChild(li);
                });
            } else {
                rankingContainer.style.display = "none";
            }

        } else {
            title.innerText = "ã“ã‚†ãã‚‚ã†é–“é•ãˆã‚“ãªã‚ˆğŸ”¥";
            title.style.color = "var(--wrong)";
            sub.innerText = `${wrongQueue.length} å€‹é–“é•ãˆãŸãªï¼\nã“ã“ã‹ã‚‰ã¯å…¨å•æ­£è§£ã™ã‚‹ã¾ã§çµ‚ã‚ã‚Šã¾ã›ãƒ¼ã‚“ï¼`;
            retryBtn.style.display = "inline-block";
            rankingContainer.style.display = "none";
        }
    }

    function startReview() {
        gameQueue = shuffle([...wrongQueue]);
        wrongQueue = [];
        allItemsCount = gameQueue.length;
        
        document.getElementById('game-items').innerHTML = "";
        showScreen('screen-game');
        updateInstruction();
        nextRound();
    }

    function shuffle(arr) {
        return arr.sort(() => Math.random() - 0.5);
    }

    // === ç·¨é›†ãƒ»ç®¡ç†æ©Ÿèƒ½ ===
    function toggleEdit() {
        const editScreen = document.getElementById('screen-edit');
        if (editScreen.classList.contains('active')) {
            goSubjects();
        } else {
            showScreen('screen-edit');
            refreshEditSubjects();
        }
    }

    function refreshEditSubjects() {
        const sel = document.getElementById('edit-subject-select');
        sel.innerHTML = '<option value="">-- ç§‘ç›®ã‚’é¸æŠ --</option>';
        Object.keys(appData).forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.innerText = s;
            sel.appendChild(opt);
        });
        document.getElementById('edit-title-group').style.display = 'none';
        document.getElementById('edit-content-group').style.display = 'none';
        document.getElementById('btn-del-subject').style.display = 'none';
    }

    function addNewSubject() {
        const name = document.getElementById('edit-new-subject').value.trim();
        if(!name) return;
        if(!appData[name]) {
            appData[name] = {};
            updateAccessLog(name);
        }
        saveData();
        document.getElementById('edit-new-subject').value = "";
        refreshEditSubjects();
        alert(`ç§‘ç›®ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
    }

    function onEditSubjectChange() {
        const subj = document.getElementById('edit-subject-select').value;
        const delBtn = document.getElementById('btn-del-subject');
        
        if (!subj) {
            delBtn.style.display = 'none';
            return;
        }
        delBtn.style.display = 'block';
        
        document.getElementById('edit-current-subject').innerText = subj;
        document.getElementById('edit-title-group').style.display = 'block';
        document.getElementById('edit-content-group').style.display = 'none';
        refreshEditTitles(subj);
    }

    function deleteSelectedSubject() {
        const subj = document.getElementById('edit-subject-select').value;
        if (!subj) return;
        
        if (confirm(`æœ¬å½“ã«ç§‘ç›®ã€Œ${subj}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nä¸­ã®å•é¡Œã‚‚ã™ã¹ã¦æ¶ˆãˆã¾ã™ã€‚`)) {
            delete appData[subj];
            saveData();
            refreshEditSubjects();
        }
    }

    function refreshEditTitles(subj) {
        const sel = document.getElementById('edit-title-select');
        sel.innerHTML = '<option value="">-- ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¸æŠ --</option>';
        const titles = appData[subj];
        Object.keys(titles).forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.innerText = t;
            sel.appendChild(opt);
        });
        document.getElementById('btn-del-title').style.display = 'none';
    }

    function addNewTitle() {
        const subj = document.getElementById('edit-subject-select').value;
        const name = document.getElementById('edit-new-title').value.trim();
        if(!name || !subj) return;
        
        if(!appData[subj][name]) {
            appData[subj][name] = {};
            updateAccessLog(`${subj}__${name}`);
        }
        saveData();
        document.getElementById('edit-new-title').value = "";
        refreshEditTitles(subj);
        alert(`ã‚¿ã‚¤ãƒˆãƒ«ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
    }

    function onEditTitleChange() {
        const subj = document.getElementById('edit-subject-select').value;
        const title = document.getElementById('edit-title-select').value;
        const delBtn = document.getElementById('btn-del-title');

        if(!title) {
            delBtn.style.display = 'none';
            return;
        }
        delBtn.style.display = 'block';

        document.getElementById('edit-current-title').innerText = title;
        document.getElementById('edit-content-group').style.display = 'block';
        refreshEditContentList(subj, title);
    }

    function deleteSelectedTitle() {
        const subj = document.getElementById('edit-subject-select').value;
        const title = document.getElementById('edit-title-select').value;
        if (!subj || !title) return;

        if (confirm(`æœ¬å½“ã«ã‚¿ã‚¤ãƒˆãƒ«ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            delete appData[subj][title];
            saveData();
            refreshEditTitles(subj);
            document.getElementById('edit-content-group').style.display = 'none';
        }
    }

    function addProblemContent() {
        const subj = document.getElementById('edit-subject-select').value;
        const title = document.getElementById('edit-title-select').value;
        const catName = document.getElementById('edit-cat-name').value.trim();
        const itemsText = document.getElementById('edit-cat-items').value.trim();

        if(!subj || !title || !catName || !itemsText) {
            alert("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        const items = itemsText.split(/\n/).map(s => s.trim()).filter(s => s);
        if(items.length === 0) return;

        appData[subj][title][catName] = items;
        saveData();
        
        document.getElementById('edit-cat-name').value = "";
        document.getElementById('edit-cat-items').value = "";
        refreshEditContentList(subj, title);
        alert("ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function refreshEditContentList(subj, title) {
        const list = document.getElementById('edit-registered-list');
        list.innerHTML = "";
        const data = appData[subj][title];
        Object.keys(data).forEach(cat => {
            const li = document.createElement('li');
            li.innerHTML = `
                <b>${cat}</b>: ${data[cat].join(", ")} 
                <div style="margin-top:5px;">
                    <button class="btn-edit" onclick="editCategory('${subj}','${title}','${cat}')">ç·¨é›†</button>
                    <button class="btn-danger" onclick="deleteCategory('${subj}','${title}','${cat}')">å‰Šé™¤</button>
                </div>
            `;
            li.style.marginBottom = "10px";
            li.style.borderBottom = "1px solid #eee";
            li.style.paddingBottom = "10px";
            list.appendChild(li);
        });
    }

    function editCategory(subj, title, cat) {
        document.getElementById('edit-cat-name').value = cat;
        document.getElementById('edit-cat-items').value = appData[subj][title][cat].join('\n');
        alert("ä¸Šã®å…¥åŠ›æ¬„ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\nä¿®æ­£ã—ã¦ã€Œä¿å­˜ã€ã—ã¦ãã ã•ã„ã€‚");
        document.getElementById('edit-content-group').scrollIntoView({behavior: 'smooth'});
    }

    function deleteCategory(subj, title, cat) {
        if(confirm(`${cat} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            delete appData[subj][title][cat];
            saveData();
            refreshEditContentList(subj, title);
        }
    }

    // === ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ ===
    function exportBackup() {
        const backupObj = {
            data: appData,
            log: accessLog,
            comp: completionLog,
            mistake: mistakeLog // â˜…é–“é•ã„ãƒ‡ãƒ¼ã‚¿ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        };
        const json = JSON.stringify(backupObj);
        
        navigator.clipboard.writeText(json).then(() => {
            alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nãƒ¡ãƒ¢å¸³ãªã©ã«è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
        }).catch(err => {
            prompt("ä»¥ä¸‹ã®æ–‡å­—ã‚’ã™ã¹ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„", json);
        });
    }

    function importBackup() {
        const json = prompt("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ãŸæ–‡å­—ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„");
        if(!json) return;
        
        try {
            const parsed = JSON.parse(json);
            if (parsed.data) {
                appData = parsed.data;
                accessLog = parsed.log || {};
                completionLog = parsed.comp || {};
                mistakeLog = parsed.mistake || {};
            } else {
                appData = parsed;
            }
            saveData();
            alert("ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼");
            refreshEditSubjects();
            goSubjects();
        } catch(e) {
            alert("ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
        }
    }

</script>

</body>
</html>