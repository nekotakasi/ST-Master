<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STéšå±¤åˆ¥åˆ†é¡ãƒã‚¹ã‚¿ãƒ¼</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --correct: #27ae60;
            --wrong: #e74c3c;
            --bg: #f5f6fa;
            --text: #2c3e50;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: var(--bg);
            margin: 0;
            color: var(--text);
            display: flex;
            justify-content: center;
            height: 100vh; /* å…¨ç”»é¢å›ºå®š */
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: var(--primary);
            color: white;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
        }

        /* ç”»é¢å…±é€šè¨­å®š */
        .screen {
            flex: 1;
            display: none; /* JSã§åˆ‡ã‚Šæ›¿ãˆ */
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
        }

        .screen.active {
            display: flex;
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆï¼ˆç§‘ç›®ãƒ»ã‚¿ã‚¤ãƒˆãƒ«é¸æŠç”¨ï¼‰ */
        .menu-list {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }

        .menu-btn {
            background: white;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            padding: 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .menu-btn:hover {
            background: var(--secondary);
            color: white;
            transform: translateY(-2px);
        }

        .section-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--secondary);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        /* --- ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆæ—§ä½œã¨åŒã˜ï¼‰ --- */
        .game-layout {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        @media (min-width: 600px) {
            .game-layout { flex-direction: row; }
        }

        .category-area {
            flex: 0 0 auto;
            max-height: 40%;
            background: #ecf0f1;
            padding: 10px;
            border-bottom: 2px solid #bdc3c7;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        @media (min-width: 600px) {
            .category-area {
                flex: 0 0 35%;
                max-height: none;
                border-bottom: none;
                border-right: 2px solid #bdc3c7;
                grid-template-columns: 1fr;
                align-content: start;
            }
        }

        .cat-btn {
            background: white;
            border: 2px solid #95a5a6;
            border-radius: 8px;
            padding: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .cat-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
        }

        .cat-btn.flash {
            background: var(--correct) !important;
            border-color: var(--correct) !important;
            color: white !important;
        }

        .items-area {
            flex: 1;
            padding: 20px;
            background: white;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .item-card {
            background: white;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: 0.2s;
            animation: popIn 0.3s ease;
        }

        .item-card:hover { transform: translateY(-2px); }
        .item-card.correct { transform: scale(0); opacity: 0; }
        .item-card.wrong { background: var(--wrong); color: white; border-color: var(--wrong); animation: shake 0.4s; }

        .progress-bar {
            background: #eee;
            height: 6px;
            width: 100%;
            margin-bottom: 10px;
        }
        .progress-fill {
            background: var(--correct);
            height: 100%;
            width: 0%;
            transition: 0.3s;
        }

        /* --- ç·¨é›†ç”»é¢ --- */
        .edit-container {
            padding: 10px;
        }
        .form-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }
        .form-label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: var(--primary);
        }
        .input-box, .select-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        .btn-danger {
            background: var(--wrong);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: 1; opacity: 1; } }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%,75%{transform:translateX(-5px)} 50%{transform:translateX(5px)} }

    </style>
</head>
<body>

<div class="container">
    <header>
        <button class="header-btn" id="back-btn" onclick="goBack()" style="visibility:hidden;">â† æˆ»ã‚‹</button>
        <div class="header-title" id="header-title">STéšå±¤åˆ¥åˆ†é¡ãƒã‚¹ã‚¿ãƒ¼</div>
        <button class="header-btn" onclick="toggleEdit()">ä½œå•</button>
    </header>

    <div id="screen-subjects" class="screen active">
        <h2 class="section-title">ç§‘ç›®ã‚’é¸æŠ</h2>
        <div class="menu-list" id="subject-list"></div>
    </div>

    <div id="screen-titles" class="screen">
        <h2 class="section-title" id="selected-subject-name"></h2>
        <div class="menu-list" id="title-list"></div>
    </div>

    <div id="screen-game" class="screen" style="padding:0; overflow:hidden;">
        <div style="padding: 10px; background: #fff; border-bottom:1px solid #eee;">
            <div class="progress-bar"><div class="progress-fill" id="progress-bar"></div></div>
            <div style="text-align:center; font-size:0.9rem;" id="game-status">æ®‹ã‚Š: 0</div>
            <div style="text-align:center; font-size:0.9rem; color:#888;" id="instruction-text">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</div>
        </div>
        
        <div class="game-layout">
            <div class="category-area" id="game-cats"></div>
            <div class="items-area">
                <div id="game-items" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen" style="text-align:center; justify-content:center;">
        <h1 id="result-msg">å®Œäº†ï¼</h1>
        <p id="result-sub">å…¨åˆ†é¡ã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ãŸ</p>
        <button class="btn-primary" id="retry-btn" onclick="startReview()" style="background:var(--wrong); margin-bottom:10px; display:none;">é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’ã™ã‚‹</button>
        <button class="btn-primary" onclick="initGame(currentSubject, currentTitle)">ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
        <button class="btn-primary" onclick="goSubjects()" style="margin-top:10px; background:var(--secondary);">ç§‘ç›®ä¸€è¦§ã«æˆ»ã‚‹</button>
    </div>

    <div id="screen-edit" class="screen">
        <h2 class="section-title">å•é¡Œã®ä½œæˆãƒ»ç·¨é›†</h2>

        <div class="form-group">
            <label class="form-label">â‘  ç§‘ç›®ã‚’é¸æŠã¾ãŸã¯æ–°è¦ä½œæˆ</label>
            <select id="edit-subject-select" class="select-box" onchange="onEditSubjectChange()">
                <option value="">-- ç§‘ç›®ã‚’é¸æŠ --</option>
            </select>
            <input type="text" id="edit-new-subject" class="input-box" placeholder="æ–°ã—ã„ç§‘ç›®åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šè§£å‰–å­¦ï¼‰">
            <button class="btn-primary" onclick="addNewSubject()">ç§‘ç›®ã‚’è¿½åŠ </button>
        </div>

        <div class="form-group" id="edit-title-group" style="display:none; border-left: 5px solid var(--accent);">
            <label class="form-label">â‘¡ ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¸æŠã¾ãŸã¯æ–°è¦ä½œæˆ</label>
            <p style="font-size:0.8rem; color:#666;">é¸æŠä¸­ã®ç§‘ç›®ï¼š<b id="edit-current-subject"></b></p>
            <select id="edit-title-select" class="select-box" onchange="onEditTitleChange()">
                <option value="">-- ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¸æŠ --</option>
            </select>
            <input type="text" id="edit-new-title" class="input-box" placeholder="æ–°ã—ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šè„³ã®æ©Ÿèƒ½ï¼‰">
            <button class="btn-primary" onclick="addNewTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ </button>
        </div>

        <div class="form-group" id="edit-content-group" style="display:none; border-left: 5px solid var(--correct);">
            <label class="form-label">â‘¢ åˆ†é¡å•é¡Œã‚’è¿½åŠ </label>
            <p style="font-size:0.8rem; color:#666;">é¸æŠä¸­ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼š<b id="edit-current-title"></b></p>
            
            <label class="form-label">å¤§æ ï¼ˆã‚«ãƒ†ã‚´ãƒªåï¼‰</label>
            <input type="text" id="edit-cat-name" class="input-box" placeholder="ä¾‹ï¼šæœç‰©">
            
            <label class="form-label">è¦ç´ ï¼ˆæ”¹è¡Œã§åŒºåˆ‡ã‚‹ï¼‰</label>
            <textarea id="edit-cat-items" class="input-box" style="height:100px;" placeholder="ä¾‹ï¼š&#13;&#10;ã‚Šã‚“ã”&#13;&#10;ã¿ã‹ã‚“"></textarea>
            
            <button class="btn-primary" onclick="addProblemContent()">ã“ã®å•é¡Œã‚’è¿½åŠ ãƒ»ä¿å­˜</button>

            <hr style="margin:20px 0; border:0; border-top:1px solid #ddd;">
            <label class="form-label">ç™»éŒ²æ¸ˆã¿ã®å¤§æ ãƒªã‚¹ãƒˆ</label>
            <ul id="edit-registered-list" style="padding-left:20px; font-size:0.9rem;"></ul>
        </div>

        <div class="form-group">
            <label class="form-label">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</label>
            <button class="btn-primary" style="background:#7f8c8d; margin-bottom:10px;" onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã—ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰</button>
            <button class="btn-primary" style="background:#7f8c8d;" onclick="importData()">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰</button>
        </div>
    </div>

</div>

<script>
    // === ãƒ‡ãƒ¼ã‚¿æ§‹é€  ===
    // data = {
    //   "ç§‘ç›®å": {
    //      "ã‚¿ã‚¤ãƒˆãƒ«å": {
    //          "å¤§æ A": ["è¦ç´ 1", "è¦ç´ 2"],
    //          "å¤§æ B": ["è¦ç´ 3"]
    //      }
    //   }
    // }
    
    const defaultData = {
        "ç·´ç¿’ç”¨": {
            "ä¾‹é¡Œï¼šç”Ÿãç‰©": {
                "æœç‰©": ["ã‚Šã‚“ã”", "ã¿ã‹ã‚“", "ãƒãƒŠãƒŠ"],
                "å‹•ç‰©": ["ã„ã¬", "ã­ã“", "ã†ã•ã"]
            }
        },
        "åŸºç¤åŒ»å­¦": {
            "è„³ã®æ©Ÿèƒ½å±€åœ¨": {
                "å‰é ­è‘‰": ["ãƒ–ãƒ­ãƒ¼ã‚«é‡", "ä¸€æ¬¡é‹å‹•é‡", "æ„æ¬²"],
                "å´é ­è‘‰": ["ã‚¦ã‚§ãƒ«ãƒ‹ãƒƒã‚±é‡", "ä¸€æ¬¡è´è¦šé‡", "æµ·é¦¬"],
                "å¾Œé ­è‘‰": ["ä¸€æ¬¡è¦–è¦šé‡", "é³¥è·æº"]
            }
        }
    };

    let appData = {};
    let currentSubject = null;
    let currentTitle = null;
    
    // ã‚²ãƒ¼ãƒ ç”¨å¤‰æ•°
    let activeCategory = null;
    let gameQueue = [];
    let wrongQueue = [];
    let allItemsCount = 0;
    const CHUNK_SIZE = 6;

    // === åˆæœŸåŒ– ===
    window.onload = () => {
        loadData();
        goSubjects();
    };

    function loadData() {
        const json = localStorage.getItem('st_hier_data');
        if (json) {
            try { appData = JSON.parse(json); } catch(e) { appData = defaultData; }
        } else {
            appData = JSON.parse(JSON.stringify(defaultData));
        }
    }

    function saveData() {
        localStorage.setItem('st_hier_data', JSON.stringify(appData));
    }

    // === ç”»é¢é·ç§» ===
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        // æˆ»ã‚‹ãƒœã‚¿ãƒ³åˆ¶å¾¡
        const backBtn = document.getElementById('back-btn');
        if (id === 'screen-subjects') {
            backBtn.style.visibility = 'hidden';
            document.getElementById('header-title').innerText = "STéšå±¤åˆ¥åˆ†é¡ãƒã‚¹ã‚¿ãƒ¼";
        } else {
            backBtn.style.visibility = 'visible';
        }
    }

    function goBack() {
        const active = document.querySelector('.screen.active').id;
        if (active === 'screen-titles') goSubjects();
        else if (active === 'screen-game') goTitles(currentSubject);
        else if (active === 'screen-result') goTitles(currentSubject);
        else if (active === 'screen-edit') goSubjects();
        else goSubjects();
    }

    // 1. ç§‘ç›®ä¸€è¦§è¡¨ç¤º
    function goSubjects() {
        currentSubject = null;
        currentTitle = null;
        const list = document.getElementById('subject-list');
        list.innerHTML = "";
        
        Object.keys(appData).forEach(subj => {
            const btn = document.createElement('div');
            btn.className = 'menu-btn';
            btn.innerText = subj;
            btn.onclick = () => goTitles(subj);
            list.appendChild(btn);
        });
        showScreen('screen-subjects');
    }

    // 2. ã‚¿ã‚¤ãƒˆãƒ«ä¸€è¦§è¡¨ç¤º
    function goTitles(subj) {
        currentSubject = subj;
        document.getElementById('selected-subject-name').innerText = subj;
        const list = document.getElementById('title-list');
        list.innerHTML = "";
        
        const titles = appData[subj] || {};
        if (Object.keys(titles).length === 0) {
            list.innerHTML = "<p style='text-align:center; width:100%; color:#888;'>ã¾ã å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å³ä¸Šã®ã€Œä½œå•ã€ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>";
        }

        Object.keys(titles).forEach(title => {
            const btn = document.createElement('div');
            btn.className = 'menu-btn';
            btn.innerText = title;
            btn.onclick = () => initGame(subj, title);
            list.appendChild(btn);
        });
        
        document.getElementById('header-title').innerText = subj;
        showScreen('screen-titles');
    }

    // 3. ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
    function initGame(subj, title) {
        currentSubject = subj;
        currentTitle = title;
        document.getElementById('header-title').innerText = title;

        const problemSet = appData[subj][title];
        
        // ãƒ‡ãƒ¼ã‚¿æ•´å½¢
        let items = [];
        for (const [cat, list] of Object.entries(problemSet)) {
            list.forEach(item => items.push({name: item, category: cat}));
        }

        gameQueue = shuffle(items);
        wrongQueue = [];
        allItemsCount = items.length;
        activeCategory = null;

        // ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³ç”Ÿæˆ
        const catArea = document.getElementById('game-cats');
        catArea.innerHTML = "";
        Object.keys(problemSet).forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'cat-btn';
            btn.innerText = cat;
            btn.onclick = () => selectCategory(cat, btn);
            catArea.appendChild(btn);
        });

        // ã‚¢ã‚¤ãƒ†ãƒ ã‚¨ãƒªã‚¢ã‚¯ãƒªã‚¢
        document.getElementById('game-items').innerHTML = "";
        
        showScreen('screen-game');
        updateInstruction();
        nextRound();
    }

    // ã‚«ãƒ†ã‚´ãƒªé¸æŠ
    function selectCategory(cat, btn) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeCategory = cat;
        updateInstruction();
    }

    function updateInstruction() {
        const text = document.getElementById('instruction-text');
        if (!activeCategory) {
            text.innerText = "â‘ å¤§æ (ã‚«ãƒ†ã‚´ãƒª)ã‚’é¸æŠã—ã¦ãã ã•ã„";
            text.style.color = "#888";
        } else {
            text.innerText = `ã€Œ${activeCategory}ã€ã«åˆ†é¡ã™ã‚‹è¦ç´ ã‚’é¸ã‚“ã§ãã ã•ã„`;
            text.style.color = "var(--accent)";
        }
    }

    // ã‚²ãƒ¼ãƒ é€²è¡Œ
    function nextRound() {
        const container = document.getElementById('game-items');
        // ã¾ã ç”»é¢ã«ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Œã°è¿½åŠ ã—ãªã„
        if (container.children.length > 0) return;

        if (gameQueue.length === 0) {
            finishGame();
            return;
        }

        const batch = gameQueue.splice(0, CHUNK_SIZE);
        batch.forEach(item => {
            const el = document.createElement('div');
            el.className = 'item-card';
            el.innerText = item.name;
            el.onclick = (e) => checkAnswer(item, e.target);
            container.appendChild(el);
        });
        updateStatus();
    }

    function checkAnswer(item, el) {
        if (!activeCategory) {
            alert("å…ˆã«ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }

        if (item.category === activeCategory) {
            // æ­£è§£
            el.classList.add('correct');
            const activeBtn = document.querySelector('.cat-btn.active');
            activeBtn.classList.add('flash');
            setTimeout(() => activeBtn.classList.remove('flash'), 300);

            setTimeout(() => {
                el.remove();
                if (document.getElementById('game-items').children.length === 0) nextRound();
                updateStatus();
            }, 300);
        } else {
            // ä¸æ­£è§£
            el.classList.add('wrong');
            if (!wrongQueue.some(w => w.name === item.name && w.category === item.category)) {
                wrongQueue.push(item);
            }
            setTimeout(() => el.classList.remove('wrong'), 400);
        }
    }

    function updateStatus() {
        const remaining = gameQueue.length + document.getElementById('game-items').children.length;
        document.getElementById('game-status').innerText = `æ®‹ã‚Š: ${remaining}`;
        const total = allItemsCount; // è¿‘ä¼¼
        const current = total - remaining;
        document.getElementById('progress-bar').style.width = `${(current/total)*100}%`;
    }

    function finishGame() {
        showScreen('screen-result');
        const title = document.getElementById('result-msg');
        const sub = document.getElementById('result-sub');
        const retryBtn = document.getElementById('retry-btn');

        if (wrongQueue.length === 0) {
            title.innerText = "å®Œå…¨ç¿’å¾—ï¼ğŸ‰";
            title.style.color = "var(--correct)";
            sub.innerText = "ç´ æ™´ã‚‰ã—ã„ï¼ã™ã¹ã¦ã®åˆ†é¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚";
            retryBtn.style.display = "none";
        } else {
            title.innerText = "å¾©ç¿’ãŒå¿…è¦ã§ã™ğŸ”¥";
            title.style.color = "var(--wrong)";
            sub.innerText = `é–“é•ã„ãŒ ${wrongQueue.length} å€‹ã‚ã‚Šã¾ã—ãŸã€‚\nå…¨å•æ­£è§£ã™ã‚‹ã¾ã§çµ‚ã‚ã‚Šã¾ã›ã‚“ï¼`;
            retryBtn.style.display = "inline-block";
        }
    }

    function startReview() {
        // å¾©ç¿’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        gameQueue = shuffle([...wrongQueue]);
        wrongQueue = [];
        // ç”»é¢ä¸Šã®ã‚«ãƒ†ã‚´ãƒªãªã©ã¯ãã®ã¾ã¾åˆ©ç”¨
        document.getElementById('game-items').innerHTML = "";
        showScreen('screen-game');
        nextRound();
    }

    function shuffle(arr) {
        return arr.sort(() => Math.random() - 0.5);
    }

    // === ç·¨é›†æ©Ÿèƒ½ ===
    function toggleEdit() {
        const editScreen = document.getElementById('screen-edit');
        if (editScreen.classList.contains('active')) {
            goSubjects();
        } else {
            showScreen('screen-edit');
            refreshEditSubjects();
        }
    }

    // ç·¨é›†ï¼šç§‘ç›®é–¢é€£
    function refreshEditSubjects() {
        const sel = document.getElementById('edit-subject-select');
        sel.innerHTML = '<option value="">-- ç§‘ç›®ã‚’é¸æŠ --</option>';
        Object.keys(appData).forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.innerText = s;
            sel.appendChild(opt);
        });
        document.getElementById('edit-title-group').style.display = 'none';
        document.getElementById('edit-content-group').style.display = 'none';
    }

    function addNewSubject() {
        const name = document.getElementById('edit-new-subject').value.trim();
        if(!name) return;
        if(!appData[name]) appData[name] = {};
        saveData();
        document.getElementById('edit-new-subject').value = "";
        refreshEditSubjects();
        alert(`ç§‘ç›®ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
    }

    function onEditSubjectChange() {
        const subj = document.getElementById('edit-subject-select').value;
        if (!subj) return;
        
        document.getElementById('edit-current-subject').innerText = subj;
        document.getElementById('edit-title-group').style.display = 'block';
        document.getElementById('edit-content-group').style.display = 'none';
        refreshEditTitles(subj);
    }

    // ç·¨é›†ï¼šã‚¿ã‚¤ãƒˆãƒ«é–¢é€£
    function refreshEditTitles(subj) {
        const sel = document.getElementById('edit-title-select');
        sel.innerHTML = '<option value="">-- ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¸æŠ --</option>';
        const titles = appData[subj];
        Object.keys(titles).forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.innerText = t;
            sel.appendChild(opt);
        });
    }

    function addNewTitle() {
        const subj = document.getElementById('edit-subject-select').value;
        const name = document.getElementById('edit-new-title').value.trim();
        if(!name || !subj) return;
        
        if(!appData[subj][name]) appData[subj][name] = {};
        saveData();
        document.getElementById('edit-new-title').value = "";
        refreshEditTitles(subj);
        alert(`ã‚¿ã‚¤ãƒˆãƒ«ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
    }

    function onEditTitleChange() {
        const subj = document.getElementById('edit-subject-select').value;
        const title = document.getElementById('edit-title-select').value;
        if(!title) return;

        document.getElementById('edit-current-title').innerText = title;
        document.getElementById('edit-content-group').style.display = 'block';
        refreshEditContentList(subj, title);
    }

    // ç·¨é›†ï¼šã‚³ãƒ³ãƒ†ãƒ³ãƒ„é–¢é€£
    function addProblemContent() {
        const subj = document.getElementById('edit-subject-select').value;
        const title = document.getElementById('edit-title-select').value;
        const catName = document.getElementById('edit-cat-name').value.trim();
        const itemsText = document.getElementById('edit-cat-items').value.trim();

        if(!subj || !title || !catName || !itemsText) {
            alert("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        const items = itemsText.split(/\n/).map(s => s.trim()).filter(s => s);
        if(items.length === 0) return;

        appData[subj][title][catName] = items;
        saveData();
        
        document.getElementById('edit-cat-name').value = "";
        document.getElementById('edit-cat-items').value = "";
        refreshEditContentList(subj, title);
        alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
    }

    function refreshEditContentList(subj, title) {
        const list = document.getElementById('edit-registered-list');
        list.innerHTML = "";
        const data = appData[subj][title];
        Object.keys(data).forEach(cat => {
            const li = document.createElement('li');
            li.innerHTML = `<b>${cat}</b>: ${data[cat].join(", ")} <button class="btn-danger" onclick="deleteCategory('${subj}','${title}','${cat}')">å‰Šé™¤</button>`;
            li.style.marginBottom = "5px";
            list.appendChild(li);
        });
    }

    function deleteCategory(subj, title, cat) {
        if(confirm(`${cat} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            delete appData[subj][title][cat];
            saveData();
            refreshEditContentList(subj, title);
        }
    }

    // ç·¨é›†ï¼šã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportData() {
        const str = JSON.stringify(appData);
        navigator.clipboard.writeText(str).then(() => alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚å­¦ç”Ÿã«é€ã£ã¦ãã ã•ã„ã€‚"));
    }

    function importData() {
        const str = prompt("ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„");
        if(str) {
            try {
                appData = JSON.parse(str);
                saveData();
                alert("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
                refreshEditSubjects();
            } catch(e) {
                alert("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
            }
        }
    }

</script>

</body>
</html>